<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>util/utils.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="FacebookCrawler.html">FacebookCrawler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="FacebookCrawler.html#.resolveResponse">resolveResponse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="FacebookCrawler.html#.searchAndSaveFBPages">searchAndSaveFBPages</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="GraphQLScalarType.html">GraphQLScalarType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GraphQLScalarType.html#.parseLiteral">parseLiteral</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GraphQLScalarType.html#.parseValue">parseValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="GraphQLScalarType.html#.serialize">serialize</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-ForeignCode-Java.html">Java</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-Java.html#.call">call</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-Java.html#.callSync">callSync</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-Java.html#.data">data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-Java.html#.kill">kill</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-ForeignCode-Python.html">Python</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-Python.html#.call">call</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-Python.html#.callSync">callSync</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-Python.html#.data">data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-Python.html#.kill">kill</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-ForeignCode-R.html">R</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-R.html#.call">call</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-R.html#.callSync">callSync</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-R.html#.data">data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode-R.html#.kill">kill</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="SentimentWorker.html">SentimentWorker</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="SentimentWorker.html#.detectSentiments">detectSentiments</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="SentimentWorker.html#.start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="SentimentWorker.html#.stop">stop</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="TopicWorker.html">TopicWorker</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="TopicWorker.html#.detectTopics">detectTopics</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="TopicWorker.html#.start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="TopicWorker.html#.stop">stop</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="TwitterCrawler.html">TwitterCrawler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="TwitterCrawler.html#.start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="TwitterCrawler.html#.track">track</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="TwitterCrawler.html#.updateTweetAuthors">updateTweetAuthors</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Connectors.html">Connectors</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Export.html">Export</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Export.html#~convertSequelizeModelToCsv">convertSequelizeModelToCsv</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Export.html#~convertToCsvRaw">convertToCsvRaw</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ForeignCode.html">ForeignCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode.html#~JavaShell">JavaShell</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode.html#~PythonShell">PythonShell</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ForeignCode.html#~RShell">RShell</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Logger.html">Logger</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-LogginMiddleware.html">LogginMiddleware</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-LogginMiddleware.html#~loggingMiddleware">loggingMiddleware</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ML_Wrapper.html">ML_Wrapper</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#.detectSentimentJavaNB">detectSentimentJavaNB</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectSarcasm">detectSarcasm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectSarcasmSync">detectSarcasmSync</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectSentimentEnsemblePython">detectSentimentEnsemblePython</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectSentimentEnsemblePythonSync">detectSentimentEnsemblePythonSync</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectSentimentEnsembleR">detectSentimentEnsembleR</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectSentimentEnsembleRSync">detectSentimentEnsembleRSync</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectTopicCTMDynamic">detectTopicCTMDynamic</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectTopicLDADynamic">detectTopicLDADynamic</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectTopicLDAStatic">detectTopicLDAStatic</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectTopicLDAStaticBatch">detectTopicLDAStaticBatch</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectTopicLDAStaticSync">detectTopicLDAStaticSync</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ML_Wrapper.html#~detectTrends">detectTrends</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Sockets.html">Sockets</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Sockets.html#~listenToSockets">listenToSockets</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Utils.html">Utils</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#~buildCommonTopicHeader">buildCommonTopicHeader</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#~commonTopicHeader">commonTopicHeader</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#~extractHashTagsFromString">extractHashTagsFromString</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#~extractHashtagsFromTweet">extractHashtagsFromTweet</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#~getKeyword">getKeyword</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#~occurrences">occurrences</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#~stripHTMLTags">stripHTMLTags</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#resolvers">resolvers</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#typeDefinitions">typeDefinitions</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">util/utils.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @module Utils 
 * @description Some useful methods for working with strings or importing data
*/
import fs from 'fs';
import csv from 'fast-csv';
import dl from 'datalib';

var _this = this;

/** 
 * @function occurrences
 * @param {String} string The string
 * @param {String} subString The sub string to search for
 * @param {Boolean} allowOverlapping Optional. (Default:false)
 * @author Vitim.us https://gist.github.com/victornpb/7736865/edit
 * @see Unit Test https://jsfiddle.net/Victornpb/5axuh96u/
 * @see http://stackoverflow.com/questions/4009756/how-to-count-string-occurrence-in-string/7924240#7924240
 * @description Function that count occurrences of a substring in a string;
 * @return {int} How many times the substring occurs
 */
var occurrences = function occurrences(string, subString, allowOverlapping) {
    string += '';
    subString += '';
    if (subString.length &lt;= 0) return string.length + 1;

    var n = 0,
        pos = 0,
        step = allowOverlapping ? 1 : subString.length;

    while (true) {
        pos = string.indexOf(subString, pos);
        if (pos >= 0) {
            ++n;
            pos += step;
        } else break;
    }
    return n;
}

/**
 * @function getKeyword
 * @param  {String} message The text to extract keyword
 * @param  {String} filters Comma separated possible keywords
 * @description Extract a keyword out of a text based on possible keywords and their occurrences in the message
 * @see @see {@link module:Utils~occurrences}
 * @return {String} The keyword which is most likely to represent the content of this text
 */
function getKeyword(message, filters) {
    var mostOcc = '';
    var key = '';
    var keywords = filters.split(',');
    keywords.map(keyword => {
        var counts = occurrences(
            message.toLowerCase(),
            keyword,
            false
        );
        if (counts > mostOcc) {
            mostOcc = counts;
            key = keyword;
        }
    });
    return key;
}

/**
 * @function stripHTMLTags
 * @param  {String} text A string containing HTML Tags
 * @description Remove all HTML tags
 * @return {String} String where every HTML tag is stripped out
 */
function stripHTMLTags(text) {
    return text.replace(/&lt;\/?[^>]+(>|$)/g, '');
}

/**
 * @function extractHashTagsFromString
 * @param  {String} text A string containing hashtags
 * @description Extract every hashtag from a given text. Returns a concatenated string of those separated by ','
 * @return {String} Concatenated string with hashtags, separated by ','
 */
function extractHashTagsFromString(text) {
    var matches = text.match(/\B\#\w\w+\b/g);
    return matches ? matches.filter((element, index, array) => index === array.indexOf(element)).join(',').replace(/#/g, '') : null; // Filter array to have uniques and join them by ","*/
}

/**
 * @function extractHashtagsFromTweet
 * @param  {Object} hashtags Hashtags object from the Twitter API
 * @description Extract every hashtag from a given Twitter API hashtags object. Returns a concatenated string of those separated by ','
 * @return {String} Concatenated string with hashtags, separated by ','
 */
function extractHashtagsFromTweet(hashtags) {
    var tags = new Array();

    hashtags.forEach((hashtag) => {
        tags.push(hashtag.text);
    }, this);
    if (hashtags.length == 0) {
        return null;
    } else {
        return tags.join(',');
    }
}


function importTweetCsv(csvFile) {

    var stream = fs.createReadStream(csvFile);
    var objects = new Array();
    csv
        .fromStream(stream, { headers: true, objectMode: true })
        .on('data', data => {
            objects.push(data);
        })
        .on('end', () => {
            var interval = 10 * 400; // 4 seconds;
            for (var i = 0; i &lt;= objects.length - 1; i++) {
                if (objects[i]['Language'] == 'eng') {
                    setTimeout(
                        i => {
                            twitterCrawler.client.get(
                                'users/search', {
                                    q: objects[i]['From.User']
                                },
                                (error, tweets, response) => {
                                    if (!error &amp;&amp; tweets[0]) {
                                        Author.upsert({
                                            id: tweets[0].id,
                                            username: tweets[0].name,
                                            screenname: tweets[0].screen_name,
                                            followercount: tweets[0].followers_count
                                        }).then(created => {
                                            Author.findOne({
                                                where: {
                                                    id: tweets[0].id
                                                }
                                            }).then(author => {
                                                Tweet.upsert({
                                                    id: objects[i]['Id'],
                                                    keywordType: 'Placeholder',
                                                    keyword: objects[i]['key'],
                                                    created: objects[i]['created_time'],
                                                    createdWeek: moment(
                                                        objects[i]['created_time'], 'dd MMM DD HH:mm:ss ZZ YYYY', 'en'
                                                    ).week(),
                                                    toUser: objects[i]['To.User'] == 'NA' ? null : objects[i]['To.User'],
                                                    language: objects[i]['Language'],
                                                    source: stripHTMLTags(
                                                        objects[i]['Source']
                                                    ),
                                                    message: objects[i]['message'],
                                                    messagePrep: null,
                                                    latitude: objects[i]['Geo.Location.Latitude'] == 'NA' ? null : objects[i]['Geo.Location.Latitude'] == 'NA',
                                                    longitude: objects[i]['Geo.Location.Longitude'] == 'NA' ? null : objects[i]['Geo.Location.Longitude'] == 'NA',
                                                    retweetCount: objects[i]['Retweet.Count'],
                                                    favorited: objects[i]['favorited'] == 'TRUE',
                                                    favoriteCount: objects[i]['favoriteCount'],
                                                    isRetweet: objects[i]['isRetweet'] == 'TRUE',
                                                    retweeted: objects[i]['retweeted'],
                                                    TWUserId: tweets[0].id,
                                                });
                                            });
                                        });
                                    };
                                });
                        },
                        interval * i,
                        i
                    );
                }
            }
        });

}

/**
 * @function buildCommonTopicHeader
 * @param  {String} csvFile Path to the csv file which contains our allocation of topic contents and their respective common topic headlines
 * @description Build an array out of our csv file which contain allocation of topic contents and their respective common topic names
 * @return {Array} Array with topic content terms and their corresponding common topic name
 */
function buildCommonTopicHeader(csvFile) {
    return new Promise((resolve, reject) => {
        var stream = fs.createReadStream(csvFile);
        var commonHeadlines = new Array();
        csv
            .fromStream(stream, { headers: true, objectMode: true })
            .on('data', data => {
                commonHeadlines.push(data);
            })
            .on('end', () => {
                resolve(commonHeadlines);
            })
    })
}

/**
 * @function commonTopicHeader
 * @param  {String} topicContent Topic content string out of database
 * @param  {Array} commonHeadlines  Array of topic contents with their headlines
 * @description Tries to find a common topic header for a given topic content based on previously build array of associations between topic contents and headline
 * @see {@link module:Utils~buildCommonTopicHeader}
 * @return {String} Common topic name for given topic content
 */
function commonTopicHeader(topicContent, commonHeadlines) {
    const terms = topicContent.split(', ');

    //flatten the result of the buildCommonTopicHeader function
    var flattened = commonHeadlines.reduce(function (result, element) {
        let index = terms.indexOf(element.term)
        if (index != -1) {
            var commonName = commonHeadlines[index];
            for (const key of Object.keys(commonName)) {
                commonName[key] = parseInt(commonName[key])
            }
            delete commonName["term"]
            return result.concat(commonName);

        } else {
            return result;
        }
    }, []);

    //Prepare reference object for extracting keys
    var referenceObj = commonHeadlines[1];
    delete referenceObj["term"]
    var termsArray = new Array();

    for (const key of Object.keys(referenceObj)) {

        var term = dl.groupby(key).count().execute(flattened).filter(element => {
            return element[key] == 1;
        })[0];

        // prepare term object
        if (term) {
            term.term = Object.keys(term)[0];
            delete term[Object.keys(term)[0]]
            termsArray.push(term)
        }
    }

    const highestTerm = termsArray.reduce((prev, current) => (prev.count > current.count) ? prev : current) //most appropriate term for list of topic content
    return highestTerm.term;
}



export {
    extractHashTagsFromString,
    extractHashtagsFromTweet,
    occurrences,
    getKeyword,
    stripHTMLTags,
    importTweetCsv,
    buildCommonTopicHeader,
    commonTopicHeader
}</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.3</a> on Sat Sep 02 2017 00:30:51 GMT+0200 (CEST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
