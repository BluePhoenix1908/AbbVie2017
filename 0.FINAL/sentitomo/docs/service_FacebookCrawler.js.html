<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: service/FacebookCrawler.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: service/FacebookCrawler.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import graph from 'fbgraph';
import request from 'request-promise';
import franc from 'franc-min'
import logger from './logger';
import { FacebookProfile, FacebookPost, FacebookComment } from '../data/connectors';

/** @class FacebookCrawler 
 *  @param  {Object} config Config object which contains the Twitter API credentials
 *  @classdesc Class for crawling Facebook data
*/
export default class FacebookCrawler {

    constructor(config) {
        this.graph = graph;
        this.graph.setAccessToken("EAACEdEose0cBADQK3mQlb59RGZABbZCUdMkGcgescEhPSmaukZB94dom8HhLsp8Fv7BTkLklFSbJH54pZAgEvkcz0nvlZCCoRnXhsfXTPFZAfaZAxMPF5EnhGO8jzIbHOtoEATAsHQliZAQZCZBvzmltJpledr32FelxoUG2VYGB0vbqYfhttKx61xAZAKjmLchcZB5qxWWEIu5AKAZDZD")
        this.graph.setVersion("2.8");
    }

    /**
     * @function searchAndSaveFBPages
     * @param  {String} keyword Keyword for searching Facebook pages
     * @description Searches for Facebook pages which match the keyword. It also inserts the found pages and their posts into the database. 
     * Only pages with matching categories (.env file config) are saved.
     * @see File /server/.env
     * @memberof FacebookCrawler
     * @return {void} 
     */
    searchAndSaveFBPages(keyword) {
        logger.info("Started Facebook search");
        var pages = new Array();
        var searchOptions = {
            q: keyword,
            type: "page",
            fields: "name,id,feed{id,link,message,story,likes,comments{id,message},created_time},category"
        }

        graph.search(searchOptions, async (err, res) => {

            pages.push(...res.data)
            var latestRes = res;

            while (latestRes.paging &amp;&amp; latestRes.paging.next) {
                var newRes = await this.resolveResponse(err, latestRes)
                pages.push(...newRes.data);
                latestRes = newRes;
            }

            // Filter pages to only get the ones with the right category
            var filteredPages = pages.filter((page) => {
                return process.env.FACEBOOK_PAGE_CATEGORY_FILTER.split(",").includes(page.category)
            });

            //Start inserting pages and posts into the db
            //profile --> posts --> comments
            filteredPages.forEach(async page => {
                page.type = "page";
                page.keyword = keyword;

                var posts = new Array();

                if (page.feed) {
                    posts.push(...page.feed.data);

                    var latestFeed = page.feed;
                    while (latestFeed.paging &amp;&amp; latestFeed.paging.next) {
                        var newFeed = await this.resolveResponse(err, latestFeed);
                        posts.push(...newFeed.data);
                        latestFeed = newFeed;
                    }
                    FacebookProfile.upsert({
                        id: page.id,
                        name: page.name,
                        category: page.category,
                        type: page.type,
                        keyword: page.keyword
                    }).then(created => { // created is an boolean indicating whether the instance was created (1) or updated (0)
                        FacebookProfile.findOne({
                            where: {
                                id: page.id
                            }
                        }).then(profile => {
                            posts.forEach(post => {
                                FacebookPost.upsert({
                                    id: post.id,
                                    message: post.message,
                                    lang: franc(post.message),
                                    story: post.story,
                                    link: post.link,
                                    created: post.created_time,
                                    FBProfileId: profile.id
                                }).then(created => {
                                    FacebookPost.findOne({
                                        where: {
                                            id: post.id
                                        }
                                    }).then(async dbPost => {
                                        var comments = new Array();
                                        comments.push(...post.comments.data);
                                        console.log(comments);
                                        var latestCommentFeed = post.comments.data
                                        while (latestCommentFeed.paging &amp;&amp; latestCommentFeed.paging.next) {
                                            var newFeed = await this.resolveResponse(err, latestCommentFeed);
                                            comments.push(...newFeed.data);
                                            latestCommentFeed = newFeed;
                                        }
                                        comments.forEach(comment => {
                                            FacebookComment.upsert({
                                                id: comment.id,
                                                message: comment.message,
                                                lang: franc(comment.message),
                                                FBPostId: dbPost.id,
                                            })
                                        })
                                    })
                                })
                            });
                        });
                    })
                }
            })
        });
    }


    /**
     * @function resolveResponse
     * @param  {Object} err Error object
     * @param  {Object} res Response object
     * @description Resolves a response from the Facebook Graph API. Useful for resolving the pagination inside the response objects.
     * @memberof FacebookCrawler
     * @return {Promise} Promise, when the new result is fetched
     */
    resolveResponse(err, res) {
        return new Promise((resolve, reject) => {
            graph.get(res.paging.next, (err, res) => {
                if (err) return reject(err);
                resolve(res);
            })
        })
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Connectors.html">Connectors</a></li><li><a href="module-Export.html">Export</a></li><li><a href="module-ForeignCode.html">ForeignCode</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-LogginMiddleware.html">LogginMiddleware</a></li><li><a href="module-ML_Wrapper.html">ML_Wrapper</a></li><li><a href="module-Preprocess.html">Preprocess</a></li><li><a href="module-Sockets.html">Sockets</a></li><li><a href="module-Utils.html">Utils</a></li></ul><h3>Classes</h3><ul><li><a href="FacebookCrawler.html">FacebookCrawler</a></li><li><a href="GraphQLScalarType.html">GraphQLScalarType</a></li><li><a href="module-ForeignCode-Java.html">Java</a></li><li><a href="module-ForeignCode-Python.html">Python</a></li><li><a href="module-ForeignCode-R.html">R</a></li><li><a href="TopicWorker.html">TopicWorker</a></li><li><a href="TwitterCrawler.html">TwitterCrawler</a></li></ul><h3>Global</h3><ul><li><a href="global.html#resolvers">resolvers</a></li><li><a href="global.html#typeDefinitions">typeDefinitions</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.3</a> on Sat Aug 12 2017 22:28:08 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
